<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BuildKart Backend Documentation</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            color: #333;
        }
        h1 {
            color: #2c3e50;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
        }
        h2 {
            color: #2980b9;
            margin-top: 30px;
            border-left: 4px solid #3498db;
            padding-left: 15px;
        }
        h3 {
            color: #16a085;
        }
        code {
            background: #f4f4f4;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            color: #c7254e;
        }
        pre {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
        }
        pre code {
            background: none;
            color: inherit;
            padding: 0;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        th, td {
            padding: 12px;
            border: 1px solid #ddd;
            text-align: left;
        }
        th {
            background: #3498db;
            color: white;
        }
        tr:nth-child(even) {
            background: #f9f9f9;
        }
        .note {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 10px;
            margin: 10px 0;
        }
        .highlight {
            background: #e8f4fd;
            padding: 10px;
            border-radius: 5px;
        }
        ul {
            padding-left: 20px;
        }
        li {
            margin: 5px 0;
        }
        @media print {
            body {
                font-size: 12pt;
            }
            pre {
                white-space: pre-wrap;
            }
        }
    </style>
</head>
<body>
    <h1>BuildKart Backend Documentation</h1>
    
    <p>A comprehensive overview of the backend logic used in the BuildKart e-commerce Django project.</p>

    <h2>1. Database Models</h2>

    <h3>1.1 Category Model</h3>
    <pre><code>from django.db import models

class Category(models.Model):
    name = models.CharField(max_length=100)
    slug = models.SlugField(unique=True)
    icon = models.CharField(max_length=50, default='fa-box')
    description = models.TextField(blank=True)
    image = models.ImageField(upload_to='categories/', blank=True, null=True)
    is_active = models.BooleanField(default=True)
    created_at = models.DateTimeField(auto_now_add=True)</code></pre>
    <p>Stores product categories with name, slug, icon, and active status. Supports image upload for categories.</p>

    <h3>1.2 Brand Model</h3>
    <pre><code>class Brand(models.Model):
    name = models.CharField(max_length=100)
    slug = models.SlugField(unique=True)
    logo = models.ImageField(upload_to='brands/', blank=True, null=True)
    description = models.TextField(blank=True)
    is_active = models.BooleanField(default=True)</code></pre>
    <p>Stores brand information with logo support.</p>

    <h3>1.3 Product Model</h3>
    <p>The main product model with comprehensive e-commerce features:</p>
    
    <h4>Category Choices:</h4>
    <pre><code>CATEGORY_CHOICES = [
    ('cement', 'Cement'),
    ('sand', 'Sand'),
    ('bricks', 'Bricks'),
    ('steel', 'Steel'),
    ('aggregates', 'Aggregates'),
    ('blocks', 'Blocks'),
    ('tools', 'Tools & Equipment'),
]

UNIT_CHOICES = [
    ('bag', 'per Bag'),
    ('ton', 'per Ton'),
    ('kg', 'per Kg'),
    ('piece', 'per Piece'),
    ('cubic_meter', 'per Cubic Meter'),
    ('cubic_feet', 'per Cubic Feet'),
]</code></pre>

    <h4>Product Fields:</h4>
    <table>
        <tr>
            <th>Field Group</th>
            <th>Fields</th>
        </tr>
        <tr>
            <td>Basic Info</td>
            <td>name, slug, sku (auto-generated), category, brand</td>
        </tr>
        <tr>
            <td>Pricing</td>
            <td>price, original_price, discount_percentage</td>
        </tr>
        <tr>
            <td>Unit</td>
            <td>unit, min_order_quantity</td>
        </tr>
        <tr>
            <td>Stock</td>
            <td>stock, in_stock (auto-calculated)</td>
        </tr>
        <tr>
            <td>Ratings</td>
            <td>rating, num_reviews</td>
        </tr>
        <tr>
            <td>Delivery</td>
            <td>delivery_days, delivery_pincodes, is_bulk_available, bulk_min_quantity</td>
        </tr>
        <tr>
            <td>Images</td>
            <td>image, images (JSON field)</td>
        </tr>
        <tr>
            <td>Status</td>
            <td>is_active, is_featured</td>
        </tr>
    </table>

    <h4>Product Save Method (Auto-calculations):</h4>
    <pre><code>def save(self, *args, **kwargs):
    if not self.sku:
        import random
        import string
        # Auto-generate SKU: BK + 8 random alphanumeric characters
        self.sku = 'BK' + ''.join(random.choices(string.ascii_uppercase + string.digits, k=8))
    if not self.original_price:
        self.original_price = self.price
    if self.discount_percentage > 0:
        self.original_price = self.price
        self.price = self.original_price - (self.original_price * self.discount_percentage / 100)
    self.in_stock = self.stock > 0
    super().save(*args, **kwargs)</code></pre>

    <h3>1.4 CartItem Model</h3>
    <pre><code>class CartItem(models.Model):
    user = models.ForeignKey(User, on_delete=models.CASCADE, null=True, blank=True)
    session_key = models.CharField(max_length=255, null=True, blank=True)
    product = models.ForeignKey(Product, on_delete=models.CASCADE)
    quantity = models.IntegerField(default=1)
    
    class Meta:
        unique_together = ['user', 'product', 'session_key']
    
    def get_total_price(self):
        return self.quantity * self.product.price</code></pre>
    <p>Supports both authenticated users and guest users (via session_key).</p>

    <h3>1.5 Order Model</h3>
    <pre><code>class Order(models.Model):
    PAYMENT_METHODS = [
        ('cod', 'Cash on Delivery'),
        ('upi', 'UPI'),
        ('card', 'Credit/Debit Card'),
        ('netbanking', 'Net Banking'),
    ]
    
    STATUS_CHOICES = [
        ('pending', 'Pending'),
        ('confirmed', 'Confirmed'),
        ('processing', 'Processing'),
        ('shipped', 'Shipped'),
        ('delivered', 'Delivered'),
        ('cancelled', 'Cancelled'),
    ]
    
    user = models.ForeignKey(User, on_delete=models.CASCADE)
    order_number = models.CharField(max_length=50, unique=True)
    shipping_address = models.ForeignKey(Address, on_delete=models.SET_NULL, null=True)
    payment_method = models.CharField(max_length=20, choices=PAYMENT_METHODS)
    payment_status = models.CharField(max_length=20, default='pending')
    status = models.CharField(max_length=20, choices=STATUS_CHOICES, default='pending')
    subtotal = models.DecimalField(max_digits=12, decimal_places=2)
    shipping_cost = models.DecimalField(max_digits=10, decimal_places=2, default=0)
    tax = models.DecimalField(max_digits=10, decimal_places=2, default=0)
    discount = models.DecimalField(max_digits=10, decimal_places=2, default=0)
    total = models.DecimalField(max_digits=12, decimal_places=2)
    
    def save(self, *args, **kwargs):
        if not self.order_number:
            import random
            import string
            self.order_number = 'BK' + ''.join(random.choices(string.ascii_uppercase + string.digits, k=10))
        super().save(*args, **kwargs)</code></pre>

    <h3>1.6 OrderItem Model</h3>
    <pre><code>class OrderItem(models.Model):
    order = models.ForeignKey(Order, on_delete=models.CASCADE)
    product = models.ForeignKey(Product, on_delete=models.CASCADE)
    quantity = models.IntegerField()
    price = models.DecimalField(max_digits=10, decimal_places=2)
    total = models.DecimalField(max_digits=12, decimal_places=2)
    
    def save(self, *args, **kwargs):
        self.total = self.quantity * self.price
        super().save(*args, **kwargs)</code></pre>

    <h3>1.7 Other Models</h3>
    <table>
        <tr>
            <th>Model</th>
            <th>Purpose</th>
        </tr>
        <tr>
            <td>ProductReview</td>
            <td>Product reviews with ratings (1-5), title, review text</td>
        </tr>
        <tr>
            <td>Wishlist</td>
            <td>User wishlist items with unique constraint (user + product)</td>
        </tr>
        <tr>
            <td>Address</td>
            <td>User delivery addresses with types (home/office/other)</td>
        </tr>
        <tr>
            <td>UserProfile</td>
            <td>Extended user profile with phone, DOB, gender, profile image</td>
        </tr>
        <tr>
            <td>Testimonial</td>
            <td>Customer testimonials with rating</td>
        </tr>
    </table>

    <h2>2. Views/Controllers</h2>

    <h3>2.1 Authentication Views</h3>
    <table>
        <tr>
            <th>View Function</th>
            <th>Description</th>
        </tr>
        <tr>
            <td>login_view()</td>
            <td>Handles user login with Django AuthenticationForm</td>
        </tr>
        <tr>
            <td>register()</td>
            <td>User registration with auto UserProfile creation</td>
        </tr>
        <tr>
            <td>logout_view()</td>
            <td>User logout with success message</td>
        </tr>
    </table>

    <h3>2.2 Product Views</h3>
    <table>
        <tr>
            <th>View Function</th>
            <th>Description</th>
        </tr>
        <tr>
            <td>home()</td>
            <td>Homepage with categories, featured products, best sellers, testimonials</td>
        </tr>
        <tr>
            <td>product_list()</td>
            <td>Product listing with filters: category, search, brand, price range, stock, sorting</td>
        </tr>
        <tr>
            <td>product_detail()</td>
            <td>Product detail page with related products and reviews</td>
        </tr>
        <tr>
            <td>search()</td>
            <td>Global search across product name, brand, category, description</td>
        </tr>
    </table>

    <h3>2.3 Cart Views</h3>
    <pre><code>@require_POST
def add_to_cart(request, product_id):
    product = get_object_or_404(Product, id=product_id, is_active=True)
    quantity = int(request.POST.get('quantity', 1))
    
    # Validate minimum order quantity
    if quantity < product.min_order_quantity:
        quantity = product.min_order_quantity
    
    # Validate stock availability
    if product.stock < quantity:
        return JsonResponse({'success': False, 'message': 'Sorry, required quantity not available'})
    
    # Support both authenticated and guest users
    if request.user.is_authenticated:
        cart_item, created = CartItem.objects.get_or_create(
            user=request.user, product=product, defaults={'quantity': quantity}
        )
        if not created:
            cart_item.quantity += quantity
            cart_item.save()
    else:
        session_key = request.session.session_key
        if not session_key:
            request.session.create()
            session_key = request.session.session_key
        cart_item, created = CartItem.objects.get_or_create(
            session_key=session_key, product=product, defaults={'quantity': quantity}
        )
        if not created:
            cart_item.quantity += quantity
            cart_item.save()
    
    return JsonResponse({'success': True, 'message': f'{product.name} added to cart!', 'cart_count': cart_count})</code></pre>

    <h4>Cart Calculation Logic:</h4>
    <pre><code>def cart(request):
    cart_items = get_cart_items(request)
    subtotal = sum(item.get_total_price() for item in cart_items)
    shipping = 0 if subtotal >= 5000 else 500  # Free shipping above ₹5000
    tax = (subtotal * 0.18)  # 18% GST
    total = subtotal + shipping + tax
    return render(request, 'kartapp/cart.html', {'cart_items': cart_items, 'subtotal': subtotal, 'shipping': shipping, 'tax': tax, 'total': total})</code></pre>

    <h3>2.4 Checkout & Order Views</h3>
    <pre><code>@login_required
def checkout(request):
    cart_items = CartItem.objects.filter(user=request.user)
    
    # Calculate totals
    subtotal = sum(item.get_total_price() for item in cart_items)
    shipping = 0 if subtotal >= 5000 else 500
    tax = (subtotal * 0.18)
    total = subtotal + shipping + tax
    
    if request.method == 'POST':
        address_id = request.POST.get('address')
        payment_method = request.POST.get('payment_method', 'cod')
        
        # Create order
        order = Order.objects.create(
            user=request.user,
            shipping_address=address,
            payment_method=payment_method,
            subtotal=subtotal,
            shipping_cost=shipping,
            tax=tax,
            total=total,
            status='confirmed'
        )
        
        # Create order items and reduce stock
        for item in cart_items:
            OrderItem.objects.create(
                order=order,
                product=item.product,
                quantity=item.quantity,
                price=item.product.price,
                total=item.get_total_price()
            )
            item.product.stock -= item.quantity
            item.product.save()
        
        cart_items.delete()  # Clear cart
        return redirect('order_confirmation', order_id=order.id)</code></pre>

    <h3>2.5 User Dashboard Views</h3>
    <table>
        <tr>
            <th>View Function</th>
            <th>Description</th>
        </tr>
        <tr>
            <td>dashboard()</td>
            <td>User dashboard with orders, wishlist, addresses, profile</td>
        </tr>
        <tr>
            <td>wishlist() / add_to_wishlist() / remove_from_wishlist()</td>
            <td>Manage user wishlist items</td>
        </tr>
        <tr>
            <td>addresses() / add_address() / edit_address() / delete_address()</td>
            <td>Manage delivery addresses</td>
        </tr>
        <tr>
            <td>profile()</td>
            <td>User profile management</td>
        </tr>
    </table>

    <h3>2.6 Helper Functions</h3>
    <pre><code># Get cart items for authenticated or guest users
def get_cart_items(request):
    if request.user.is_authenticated:
        return CartItem.objects.filter(user=request.user)
    else:
        session_key = request.session.session_key
        if not session_key:
            request.session.create()
            session_key = request.session.session_key
        return CartItem.objects.filter(session_key=session_key)

# Get total cart count
def get_cart_count(request):
    cart_items = get_cart_items(request)
    return sum(item.quantity for item in cart_items)</code></pre>

    <h2>3. Forms</h2>
    <table>
        <tr>
            <th>Form</th>
            <th>Description</th>
        </tr>
        <tr>
            <td>UserProfileForm</td>
            <td>Extended profile form with user fields (first_name, last_name, email)</td>
        </tr>
        <tr>
            <td>AddressForm</td>
            <td>Delivery address form with all address fields</td>
        </tr>
        <tr>
            <td>ProductReviewForm</td>
            <td>Product review form with rating, title, review text</td>
        </tr>
        <tr>
            <td>UserRegistrationForm</td>
            <td>Custom registration with phone field, auto UserProfile creation</td>
        </tr>
    </table>

    <h2>4. URL Routing</h2>
    <pre><code>urlpatterns = [
    # Home
    path('', views.home_redirect, name='home'),
    
    # Products - Protected (requires login)
    path('products/', login_required(views.product_list), name='product_list'),
    path('products/<slug:category_slug>/', login_required(views.product_list), name='product_list_by_category'),
    path('product/<int:product_id>/', login_required(views.product_detail), name='product_detail'),
    
    # Cart - Protected
    path('cart/', login_required(views.cart), name='cart'),
    path('cart/add/<int:product_id>/', login_required(views.add_to_cart), name='add_to_cart'),
    path('cart/update/<int:item_id>/', login_required(views.update_cart), name='update_cart'),
    path('cart/remove/<int:item_id>/', login_required(views.remove_from_cart), name='remove_from_cart'),
    
    # Checkout - Protected
    path('checkout/', login_required(views.checkout), name='checkout'),
    path('order/confirmation/<int:order_id>/', login_required(views.order_confirmation), name='order_confirmation'),
    
    # User Dashboard - Protected
    path('dashboard/', login_required(views.dashboard), name='dashboard'),
    path('orders/', login_required(views.orders), name='orders'),
    path('wishlist/', login_required(views.wishlist), name='wishlist'),
    path('addresses/', login_required(views.addresses), name='addresses'),
    path('profile/', login_required(views.profile), name='profile'),
    
    # Auth - Public
    path('login/', views.login_view, name='login'),
    path('register/', views.register, name='register'),
    path('logout/', views.logout_view, name='logout'),
]</code></pre>
    <div class="note">
        <strong>Note:</strong> All product, cart, checkout, and dashboard URLs are protected with <code>@login_required</code>. Only login, register, and logout are public.
    </div>

    <h2>5. Context Processors</h2>
    <pre><code>def categories(request):
    """Add categories to all templates"""
    categories = Category.objects.filter(is_active=True)
    return {'all_categories': categories}

def cart_context(request):
    """Add cart info to all templates"""
    cart_items = get_cart_items(request)
    cart_count = sum(item.quantity for item in cart_items)
    cart_total = sum(item.get_total_price() for item in cart_items)
    return {'cart_count': cart_count, 'cart_total': cart_total}</code></pre>

    <h2>6. Admin Configuration</h2>
    <table>
        <tr>
            <th>Model Admin</th>
            <th>Features</th>
        </tr>
        <tr>
            <td>CategoryAdmin</td>
            <td>list_display: name, slug, icon, is_active | prepopulated_fields: slug | list_filter: is_active | search_fields: name, description</td>
        </tr>
        <tr>
            <td>BrandAdmin</td>
            <td>list_display: name, slug, is_active | prepopulated_fields: slug | search_fields: name</td>
        </tr>
        <tr>
            <td>ProductAdmin</td>
            <td>Comprehensive fieldsets for all product sections | readonly: sku, created_at, updated_at | list_display: name, sku, category, brand, price, stock, is_active, is_featured</td>
        </tr>
        <tr>
            <td>OrderAdmin</td>
            <td>Includes OrderItemInline for viewing order items | readonly_fields: order_number, created_at, updated_at</td>
        </tr>
    </table>

    <h2>7. Key Business Logic Features</h2>
    <div class="highlight">
        <ol>
            <li><strong>Auto-generated SKUs:</strong> Products get unique 'BK' + 8 char alphanumeric</li>
            <li><strong>Auto-generated Order Numbers:</strong> Orders get unique 'BK' + 10 char alphanumeric</li>
            <li><strong>Discount Calculation:</strong> Price auto-calculated from original_price and>
            <li discount_percentage</li><strong>Stock Management:</strong> in_stock auto-set based on stock > 0</li>
            <li><strong>Cart for Guests:</strong> Uses session_key for unauthenticated users</li>
            <li><strong>Free Shipping:</strong> Shipping free for orders ≥ ₹5000</li>
            <li><strong>GST Tax:</strong> 18% tax calculated on subtotal</li>
            <li><strong>Stock Reduction:</strong> Stock decreases after successful order</li>
        </ol>
    </div>

    <h2>8. Steps to Add Items Through Admin</h2>
    <ol>
        <li>Run the server: <code>python manage.py runserver</code></li>
        <li>Access admin: <code>http://127.0.0.1:8000/admin/</code></li>
        <li>Login with superuser credentials</li>
        <li><strong>Add Categories first</strong> (required for products):
            <ul>
                <li>Click Categories → Add Category</li>
                <li>Fill: Name, Slug (auto), Icon, Description, Is Active</li>
                <li>Save</li>
            </ul>
        </li>
        <li><strong>Add Brands</strong>:
            <ul>
                <li>Click Brands → Add Brand</li>
                <li>Fill: Name, Slug (auto), Logo (optional), Description, Is Active</li>
                <li>Save</li>
            </ul>
        </li>
        <li><strong>Add Products</strong>:
            <ul>
                <li>Click Products → Add Product</li>
                <li>Fill all sections: Basic Info, Pricing, Stock, Details, Delivery, Images, Status</li>
                <li>SKU auto-generates</li>
                <li>Save</li>
            </ul>
        </li>
    </ol>

    <hr>
    <p style="text-align: center; color: #7f8c8d;">
        BuildKart E-Commerce Project - Backend Documentation<br>
        Generated for Django Project
    </p>
</body>
</html>
